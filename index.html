import React, { useState, useEffect, useRef } from 'react';
import { 
  CheckCircle, 
  Copy, 
  Download, 
  Plus, 
  Trash2, 
  Target, 
  Eye, 
  MousePointer2, 
  MessageCircle,
  TrendingUp,
  Users,
  Video,
  Upload,
  FileSpreadsheet
} from 'lucide-react';

/**
 * SOCIAL MEDIA SPECS & LOGIC
 */
const PLATFORMS = {
  Facebook: {
    primary: { safe: 125, max: 63206, lines: 3 },
    headline: { safe: 27, max: 255 },
    desc: { safe: 30, max: 30 },
    hashtags: false
  },
  Instagram: {
    primary: { safe: 125, max: 2200, lines: 2 }, // Caption
    headline: { safe: 0, max: 0 },
    desc: { safe: 0, max: 0 },
    hashtags: true
  },
  LinkedIn: {
    primary: { safe: 210, max: 3000, lines: 4 }, // Organic
    headline: { safe: 70, max: 200 }, // Short headline usually better
    desc: { safe: 100, max: 200 },
    hashtags: true
  },
  X: {
    primary: { safe: 280, max: 280, lines: 10 },
    headline: { safe: 0, max: 0 },
    desc: { safe: 0, max: 0 },
    hashtags: true
  }
};

/**
 * EXPANDED KPIs
 */
const KPIS = {
  TRAFFIC: { label: 'Traffic (Clicks)', icon: MousePointer2, color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-200' },
  AWARENESS: { label: 'Brand Awareness', icon: Eye, color: 'text-purple-600', bg: 'bg-purple-50', border: 'border-purple-200' },
  ENGAGEMENT: { label: 'Engagement', icon: MessageCircle, color: 'text-pink-600', bg: 'bg-pink-50', border: 'border-pink-200' },
  LEADS: { label: 'Lead Gen', icon: Users, color: 'text-emerald-600', bg: 'bg-emerald-50', border: 'border-emerald-200' },
  VIDEO_VIEWS: { label: 'Video Views', icon: Video, color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200' },
  CONVERSION: { label: 'Conversions', icon: TrendingUp, color: 'text-indigo-600', bg: 'bg-indigo-50', border: 'border-indigo-200' }
};

const DEFAULT_ROW = {
  id: 1,
  code: '', // New Column
  platform: 'Facebook',
  type: 'Static',
  kpi: 'TRAFFIC',
  primaryText: '',
  headline: '',
  linkDesc: '',
  visualText: '',
  notes: ''
};

const App = () => {
  const [rows, setRows] = useState([DEFAULT_ROW]);
  const fileInputRef = useRef(null);
  const [isLoadingLibrary, setIsLoadingLibrary] = useState(false);

  const addRow = () => {
    const newRow = { ...DEFAULT_ROW, id: Date.now() };
    setRows([...rows, newRow]);
  };

  const deleteRow = (id) => {
    if (rows.length > 1) {
      setRows(rows.filter(r => r.id !== id));
    }
  };

  const updateRow = (id, field, value) => {
    setRows(rows.map(r => r.id === id ? { ...r, [field]: value } : r));
  };

  const duplicateRow = (row) => {
    const newRow = { ...row, id: Date.now() };
    setRows([...rows, newRow]);
  };

  const smartFill = (sourceRow, targetPlatform) => {
    const newRow = {
      ...sourceRow,
      id: Date.now(),
      platform: targetPlatform,
    };
    setRows([...rows, newRow]);
  };

  // --- IMPORT LOGIC (CSV & XLSX) ---
  const handleFileUpload = async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
      await processXLSX(file);
    } else {
      // Default to CSV
      const reader = new FileReader();
      reader.onload = (e) => {
        processCSV(e.target.result);
      };
      reader.readAsText(file);
    }
    
    // Reset input
    if (fileInputRef.current) fileInputRef.current.value = ''; 
  };

  const loadXLSXLibrary = () => {
    return new Promise((resolve, reject) => {
      if (window.XLSX) {
        resolve(window.XLSX);
        return;
      }
      setIsLoadingLibrary(true);
      const script = document.createElement('script');
      script.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
      script.onload = () => {
        setIsLoadingLibrary(false);
        resolve(window.XLSX);
      };
      script.onerror = () => {
        setIsLoadingLibrary(false);
        reject(new Error("Failed to load XLSX library"));
      };
      document.body.appendChild(script);
    });
  };

  const processXLSX = async (file) => {
    try {
      const XLSX = await loadXLSXLibrary();
      const reader = new FileReader();
      reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" }); // Array of arrays
        
        if (json.length > 0) {
           processArrayData(json);
        }
      };
      reader.readAsArrayBuffer(file);
    } catch (err) {
      alert("Error parsing Excel file. " + err.message);
    }
  };

  const processCSV = (csvText) => {
    const parseCSVLine = (line) => {
        const result = [];
        let start = 0;
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
            if (line[i] === '"') {
                inQuotes = !inQuotes;
            } else if (line[i] === ',' && !inQuotes) {
                result.push(line.substring(start, i).replace(/^"|"$/g, '').replace(/""/g, '"'));
                start = i + 1;
            }
        }
        result.push(line.substring(start).replace(/^"|"$/g, '').replace(/""/g, '"'));
        return result;
    };
    const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
    const data = lines.map(parseCSVLine);
    processArrayData(data);
  };

  // Shared processing logic for both CSV and XLSX
  const processArrayData = (rowsArray) => {
    if (rowsArray.length < 2) {
        alert("File seems empty or invalid.");
        return;
    }

    // Extract headers (first row)
    const headers = rowsArray[0].map(h => String(h).toLowerCase().trim());
    
    // Fuzzy Mapping
    const mappings = {
        code: -1,
        primaryText: -1,
        headline: -1,
        linkDesc: -1,
        visualText: -1,
        notes: -1,
        platform: -1,
        type: -1
    };

    const keywords = {
        code: ['code', 'case', 'naam', 'name', 'campagne', 'campaign', 'fase', 'project'],
        primaryText: ['primary', 'primaire', 'text', 'tekst', 'copy', 'caption', 'intro', 'body', 'bericht'],
        headline: ['headline', 'kop', 'title', 'titel', 'header', 'onderwerp'],
        linkDesc: ['desc', 'beschrijving', 'extra', 'sub'],
        visualText: ['visual', 'beeld', 'image', 'overlay', 'foto'],
        notes: ['note', 'opmerking', 'bijzonderheden', 'comment', 'to do'],
        platform: ['platform', 'channel', 'kanaal', 'social', 'medium'],
        type: ['type', 'format', 'soort', 'vorm']
    };

    // Determine mappings
    headers.forEach((header, index) => {
        for (const [field, keys] of Object.entries(keywords)) {
            if (mappings[field] === -1 && keys.some(k => header.includes(k))) {
                mappings[field] = index;
            }
        }
    });

    const newRows = [];
    for (let i = 1; i < rowsArray.length; i++) {
        const columns = rowsArray[i];
        if (columns.length < 1) continue;

        let code = mappings.code > -1 ? columns[mappings.code] : columns[0]; // Default to col 0 if no code found
        let platform = 'Facebook';
        let type = 'Static';
        
        // --- INTELLIGENT PARSING ---
        // 1. Try explicit columns
        if (mappings.platform > -1) platform = normalizePlatform(columns[mappings.platform]);
        if (mappings.type > -1) type = normalizeType(columns[mappings.type]);

        // 2. Fallback: Detect Platform/Type from the 'Code' string if strictly needed
        const codeStr = String(code).toLowerCase();
        
        if (mappings.platform === -1) {
            if (codeStr.includes('facebook') || codeStr.includes(' fb ')) platform = 'Facebook';
            else if (codeStr.includes('instagram') || codeStr.includes(' insta ') || codeStr.includes(' ig ')) platform = 'Instagram';
            else if (codeStr.includes('linkedin') || codeStr.includes(' li ')) platform = 'LinkedIn';
            else if (codeStr.includes('twitter') || codeStr.includes(' x ')) platform = 'X';
        }
        
        if (mappings.type === -1) {
            if (codeStr.includes('video')) type = 'Video';
            else if (codeStr.includes('carousel')) type = 'Carousel';
            else if (codeStr.includes('story')) type = 'Story';
        }

        newRows.push({
            id: Date.now() + i,
            code: code || '',
            platform: normalizePlatform(platform),
            type: normalizeType(type),
            kpi: 'TRAFFIC',
            primaryText: mappings.primaryText > -1 ? columns[mappings.primaryText] || '' : '',
            headline: mappings.headline > -1 ? columns[mappings.headline] || '' : '',
            linkDesc: mappings.linkDesc > -1 ? columns[mappings.linkDesc] || '' : '',
            visualText: mappings.visualText > -1 ? columns[mappings.visualText] || '' : '',
            notes: mappings.notes > -1 ? columns[mappings.notes] || '' : '',
        });
    }

    if (newRows.length > 0) {
        setRows(prev => {
            if (prev.length === 1 && prev[0].primaryText === '') return newRows;
            return [...prev, ...newRows];
        });
        alert(`Success! ${newRows.length} items imported.`);
    }
  };

  const normalizePlatform = (val) => {
    if (!val) return 'Facebook';
    const v = String(val).toLowerCase();
    if (v.includes('insta')) return 'Instagram';
    if (v.includes('link')) return 'LinkedIn';
    if (v.includes('twitter') || v.includes('x')) return 'X';
    return 'Facebook';
  };

  const normalizeType = (val) => {
    if (!val) return 'Static';
    const v = String(val).toLowerCase();
    if (v.includes('video')) return 'Video';
    if (v.includes('carousel')) return 'Carousel';
    if (v.includes('story')) return 'Story';
    return 'Static';
  };

  const exportCSV = () => {
    const headers = [
      "Code", "Platform", "Type", "KPI", "Primary Text", "Headline", "Link Description", "Visual Text", "Notes"
    ];
    
    const csvContent = [
      headers.join(","),
      ...rows.map(row => [
        `"${String(row.code).replace(/"/g, '""')}"`,
        `"${row.platform}"`,
        `"${row.type}"`,
        `"${row.kpi}"`,
        `"${row.primaryText.replace(/"/g, '""')}"`,
        `"${row.headline.replace(/"/g, '""')}"`,
        `"${row.linkDesc.replace(/"/g, '""')}"`,
        `"${row.visualText.replace(/"/g, '""')}"`,
        `"${row.notes.replace(/"/g, '""')}"`
      ].join(","))
    ].join("\n");

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "campaign_export.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans pb-20">
      {/* HEADER */}
      <header className="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-20 shadow-sm">
        <div className="max-w-[1700px] mx-auto flex justify-between items-center">
          <div>
            <h1 className="text-xl font-bold flex items-center gap-2 text-slate-800">
              <Target className="w-6 h-6 text-indigo-600" />
              Social Campaign Cockpit
            </h1>
            <p className="text-xs text-slate-500 mt-1">Optimization Engine V3.0 (XLSX Support)</p>
          </div>
          <div className="flex gap-3">
             {/* Hidden Input for Import */}
            <input 
              type="file" 
              accept=".csv, .xlsx, .xls" 
              ref={fileInputRef}
              onChange={handleFileUpload}
              className="hidden" 
            />
            
            <button 
              onClick={() => fileInputRef.current.click()}
              disabled={isLoadingLibrary}
              className="flex items-center gap-2 px-4 py-2 bg-white text-slate-600 border border-slate-300 rounded-md hover:bg-slate-50 font-medium text-sm transition-colors disabled:opacity-50"
            >
              <Upload className="w-4 h-4" /> 
              {isLoadingLibrary ? 'Loading engine...' : 'Import File'}
            </button>
            <button 
              onClick={exportCSV}
              className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-medium text-sm shadow-sm transition-colors"
            >
              <Download className="w-4 h-4" /> Export CSV
            </button>
          </div>
        </div>
      </header>

      {/* MAIN GRID */}
      <main className="max-w-[1700px] mx-auto py-6 overflow-x-auto px-4">
        <div className="bg-white border border-slate-200 shadow-sm rounded-lg min-w-[1550px]">
          
          {/* Table Header */}
          {/* Added 'Code' column width at start */}
          <div className="grid grid-cols-[150px_120px_100px_140px_1.5fr_1fr_1fr_0.8fr_0.8fr_50px] gap-0 border-b border-slate-200 bg-slate-50 text-xs font-semibold text-slate-500 uppercase tracking-wider sticky top-0 z-10">
            <div className="p-3 border-r border-slate-100">Code / Case</div>
            <div className="p-3 border-r border-slate-100">Platform</div>
            <div className="p-3 border-r border-slate-100">Format</div>
            <div className="p-3 border-r border-slate-100">Goal (KPI)</div>
            <div className="p-3 border-r border-slate-100 flex justify-between">
              Primary Text
              <span className="text-[10px] normal-case font-normal text-slate-400">ðŸŸ§ = hidden</span>
            </div>
            <div className="p-3 border-r border-slate-100">Headline</div>
            <div className="p-3 border-r border-slate-100">Link Desc.</div>
            <div className="p-3 border-r border-slate-100">Visual Text</div>
            <div className="p-3 border-r border-slate-100">Notes</div>
            <div className="p-3 text-center">Actions</div>
          </div>

          {/* Table Body */}
          {rows.map((row) => (
            <RowItem 
              key={row.id} 
              row={row} 
              updateRow={updateRow} 
              deleteRow={deleteRow}
              duplicateRow={duplicateRow}
              smartFill={smartFill}
            />
          ))}
        </div>
        
        <div className="mt-8 text-center">
            <button 
              onClick={addRow}
              className="inline-flex items-center gap-2 px-6 py-3 bg-white border border-slate-300 text-slate-600 rounded-full hover:bg-slate-50 font-medium text-sm shadow-sm transition-colors"
            >
              <Plus className="w-4 h-4" /> Add New Item
            </button>
        </div>
      </main>
    </div>
  );
};

/**
 * INDIVIDUAL ROW COMPONENT
 */
const RowItem = ({ row, updateRow, deleteRow, duplicateRow, smartFill }) => {
  const specs = PLATFORMS[row.platform];
  const kpiData = KPIS[row.kpi] || KPIS.TRAFFIC;

  const handleSmartCopy = (target) => {
    smartFill(row, target);
  };

  return (
    <div className="group grid grid-cols-[150px_120px_100px_140px_1.5fr_1fr_1fr_0.8fr_0.8fr_50px] gap-0 border-b border-slate-100 hover:bg-slate-50 transition-colors items-start relative min-h-[140px]">
      
      {/* 0. CODE (New Column) */}
      <div className="p-2 border-r border-slate-100 h-full">
        <textarea 
            className="w-full text-xs font-semibold text-slate-600 p-2 bg-slate-50 border border-slate-200 rounded focus:border-indigo-500 focus:bg-white h-full min-h-[100px] resize-none"
            placeholder="e.g. Campaign Name / Code"
            value={row.code}
            onChange={(e) => updateRow(row.id, 'code', e.target.value)}
        />
      </div>

      {/* 1. Platform */}
      <div className="p-2 border-r border-slate-100 h-full flex flex-col justify-between">
        <select 
          className="w-full text-sm font-medium text-slate-700 bg-transparent border-none focus:ring-0 p-1 cursor-pointer"
          value={row.platform}
          onChange={(e) => updateRow(row.id, 'platform', e.target.value)}
        >
          {Object.keys(PLATFORMS).map(p => <option key={p} value={p}>{p}</option>)}
        </select>
        
        {/* Quick Duplicate Menu */}
        <div className="mt-2 opacity-0 group-hover:opacity-100 transition-opacity">
           <span className="text-[9px] text-slate-400 font-bold block mb-1">DUPLICATE TO:</span>
           <div className="flex flex-wrap gap-1">
            <button 
                onClick={() => duplicateRow(row)}
                title={`Duplicate to ${row.platform} (Same)`}
                className="text-[9px] px-1.5 py-0.5 bg-indigo-100 text-indigo-700 rounded border border-indigo-200 font-semibold hover:bg-indigo-200"
             >
               SAME
             </button>
             {Object.keys(PLATFORMS).filter(p => p !== row.platform).map(p => (
               <button 
                  key={p}
                  onClick={() => handleSmartCopy(p)}
                  title={`Smart Copy to ${p}`}
                  className="text-[9px] px-1.5 py-0.5 bg-slate-200 text-slate-600 rounded hover:bg-slate-300"
               >
                 {p.substring(0,2).toUpperCase()}
               </button>
             ))}
           </div>
        </div>
      </div>

      {/* 2. Format */}
      <div className="p-2 border-r border-slate-100 h-full">
        <select 
          className="w-full text-xs text-slate-600 bg-slate-50 border border-slate-200 rounded p-1"
          value={row.type}
          onChange={(e) => updateRow(row.id, 'type', e.target.value)}
        >
          <option value="Static">Static Img</option>
          <option value="Video">Video</option>
          <option value="Carousel">Carousel</option>
          <option value="Story">Story</option>
        </select>
      </div>

      {/* 3. KPI Selector */}
      <div className="p-2 border-r border-slate-100 h-full">
        <select
          className={`w-full text-xs p-1.5 rounded border font-medium ${kpiData.color} ${kpiData.bg} ${kpiData.border} outline-none cursor-pointer`}
          value={row.kpi}
          onChange={(e) => updateRow(row.id, 'kpi', e.target.value)}
        >
          {Object.entries(KPIS).map(([key, data]) => (
            <option key={key} value={key}>{data.label}</option>
          ))}
        </select>
        
        <div className="mt-2 text-[10px] text-slate-500 flex gap-1 items-start">
           <kpiData.icon className="w-3 h-3 flex-shrink-0 mt-0.5" />
           <span className="leading-tight opacity-80">
             {row.kpi === 'TRAFFIC' && "Strict length checks for CTA."}
             {row.kpi === 'AWARENESS' && "Focus on clear branding."}
             {row.kpi === 'ENGAGEMENT' && "Checks for questions."}
             {row.kpi === 'LEADS' && "Value prop visibility."}
             {row.kpi === 'VIDEO_VIEWS' && "Hook in first sentence."}
             {row.kpi === 'CONVERSION' && "Strong urgency required."}
           </span>
        </div>
      </div>

      {/* 4. PRIMARY TEXT (Rich Editor) */}
      <div className="p-2 border-r border-slate-100 h-full relative min-h-[140px]">
        <LayeredTextArea 
          value={row.primaryText}
          onChange={(val) => updateRow(row.id, 'primaryText', val)}
          limit={specs.primary.safe}
          max={specs.primary.max}
          linesLimit={specs.primary.lines}
          kpi={row.kpi}
          type="primary"
        />
      </div>

      {/* 5. Headline */}
      <div className="p-2 border-r border-slate-100 h-full bg-slate-50/30">
        {specs.headline.max > 0 ? (
          <LayeredTextArea 
            value={row.headline}
            onChange={(val) => updateRow(row.id, 'headline', val)}
            limit={specs.headline.safe}
            max={specs.headline.max}
            kpi={row.kpi}
            type="headline"
            rows={2}
          />
        ) : (
          <div className="text-xs text-slate-300 italic p-2 text-center mt-4">N/A for {row.platform}</div>
        )}
      </div>

      {/* 6. Link Description */}
      <div className="p-2 border-r border-slate-100 h-full">
         {specs.desc.max > 0 ? (
          <LayeredTextArea 
            value={row.linkDesc}
            onChange={(val) => updateRow(row.id, 'linkDesc', val)}
            limit={specs.desc.safe}
            max={specs.desc.max}
            kpi={row.kpi}
            type="plain"
            rows={2}
          />
        ) : (
          <div className="text-xs text-slate-300 italic p-2 text-center mt-4">N/A for {row.platform}</div>
        )}
      </div>

      {/* 7. Visual Text */}
      <div className="p-2 border-r border-slate-100 h-full">
        <textarea 
          className="w-full text-xs p-2 border border-slate-200 rounded focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 h-full min-h-[100px] bg-white"
          placeholder="Text on image..."
          value={row.visualText}
          onChange={(e) => updateRow(row.id, 'visualText', e.target.value)}
        />
      </div>

      {/* 8. Notes */}
      <div className="p-2 border-r border-slate-100 h-full">
        <textarea 
          className="w-full text-xs p-2 border-transparent bg-transparent hover:bg-white hover:border-slate-200 rounded focus:border-indigo-500 focus:bg-white h-full min-h-[100px]"
          placeholder="Notes..."
          value={row.notes}
          onChange={(e) => updateRow(row.id, 'notes', e.target.value)}
        />
      </div>

      {/* 9. Actions */}
      <div className="p-2 flex flex-col items-center gap-2 pt-4">
        <button 
          onClick={() => duplicateRow(row)}
          title="Duplicate Row"
          className="text-slate-400 hover:text-indigo-600 transition-colors"
        >
          <Copy className="w-4 h-4" />
        </button>
        <button 
          onClick={() => deleteRow(row.id)}
          title="Delete Row"
          className="text-slate-400 hover:text-red-500 transition-colors"
        >
          <Trash2 className="w-4 h-4" />
        </button>
      </div>

    </div>
  );
};

/**
 * LAYERED TEXT AREA
 */
const LayeredTextArea = ({ value, onChange, limit, max, linesLimit = 100, kpi, type, rows = 4 }) => {
  const [warnings, setWarnings] = useState([]);
  const textareaRef = useRef(null);
  const backdropRef = useRef(null);
  
  const charCount = value.length;
  
  const handleScroll = () => {
    if (textareaRef.current && backdropRef.current) {
      backdropRef.current.scrollTop = textareaRef.current.scrollTop;
    }
  };
  
  let splitIndex = limit;
  
  // 1. Check for newline limit
  let lineBreakIndex = -1;
  let linesFound = 0;
  for(let i = 0; i < value.length; i++) {
      if(value[i] === '\n') {
          linesFound++;
          if(linesFound >= linesLimit) {
              lineBreakIndex = i;
              break;
          }
      }
  }

  if (lineBreakIndex !== -1 && lineBreakIndex < splitIndex) {
      splitIndex = lineBreakIndex + 1;
  }

  const safeText = value.slice(0, splitIndex);
  const unsafeText = value.slice(splitIndex);

  const isOverSafe = unsafeText.length > 0;
  const isOverMax = charCount > max;

  useEffect(() => {
    const newWarnings = [];
    const lowerVal = value.toLowerCase();
    
    if ((kpi === 'TRAFFIC') && type === 'primary') {
      if (!value.includes('?') && !value.includes('!') && !value.includes('ðŸ‘‰') && !value.includes('ðŸ‘‡')) {
        newWarnings.push("Tip: Add an action trigger (?, !, ðŸ‘‰)");
      }
      if (isOverSafe) {
         newWarnings.push("Warning: CTA might be hidden behind 'Read More'.");
      }
    }

    if (kpi === 'ENGAGEMENT' && type === 'primary') {
      if (!value.includes('?')) {
        newWarnings.push("Tip: Ask a question to drive comments.");
      }
    }

    if (kpi === 'LEADS' && type === 'primary') {
      const leadWords = ['sign up', 'join', 'download', 'register', 'apply', 'get', 'claim'];
      if (!leadWords.some(w => lowerVal.includes(w))) {
         newWarnings.push("Tip: Use clear action verbs (Sign up, Download, etc.)");
      }
    }

    if (kpi === 'CONVERSION' && type === 'primary') {
      const urgencyWords = ['now', 'today', 'limited', 'only', 'ends', 'last chance'];
      if (!urgencyWords.some(w => lowerVal.includes(w))) {
         newWarnings.push("Tip: Create urgency (Now, Limited time, Today only).");
      }
    }
    
    if ((kpi === 'REACH' || kpi === 'AWARENESS') && type === 'primary' && limit > 100) {
       if (!value.includes('#')) newWarnings.push("Tip: Add hashtags for reach.");
    }

    setWarnings(newWarnings);
  }, [value, kpi, limit, type, isOverSafe, charCount]);


  return (
    <div className="relative h-full flex flex-col min-h-[140px] w-full">
      <div className="relative flex-grow w-full border border-slate-200 rounded overflow-hidden bg-white focus-within:ring-1 focus-within:ring-indigo-500 focus-within:border-indigo-500">
        <div 
          ref={backdropRef}
          className="absolute inset-0 p-2 text-xs font-mono leading-relaxed whitespace-pre-wrap break-words pointer-events-none select-none z-0 overflow-hidden text-transparent"
        >
          {safeText}
          <span className="bg-orange-100 text-transparent decoration-clone box-decoration-clone rounded px-0.5">
            {unsafeText}
          </span>
        </div>

        <textarea
          ref={textareaRef}
          onScroll={handleScroll}
          className="relative z-10 w-full h-full text-xs p-2 bg-transparent border-none focus:ring-0 resize-none font-mono leading-relaxed text-slate-800"
          value={value}
          onChange={(e) => onChange(e.target.value)}
          spellCheck="false"
          placeholder={type === 'primary' ? "Type copy here..." : ""}
        />
        
        {isOverMax && (
          <div className="absolute inset-0 border-2 border-red-500 pointer-events-none rounded"></div>
        )}
      </div>

      <div className="flex justify-between items-start mt-1">
        <div className="flex-1 pr-2">
          {warnings.length > 0 ? (
            <div className="text-[10px] text-orange-600 font-medium leading-tight">
              {warnings.map((w, i) => <div key={i}>{w}</div>)}
            </div>
          ) : charCount > 0 ? (
             <div className="text-[10px] text-green-600 font-medium flex items-center gap-1">
               <CheckCircle className="w-3 h-3" /> Optimum
             </div>
          ) : null}
        </div>

        <div className={`text-[10px] font-mono font-bold whitespace-nowrap flex flex-col items-end ${
          isOverMax ? 'text-red-600' : isOverSafe ? 'text-orange-500' : 'text-slate-400'
        }`}>
          <span>{charCount} / {limit}</span>
          {isOverSafe && <span className="text-[9px] uppercase font-bold text-orange-400">Read More Active</span>}
        </div>
      </div>
    </div>
  );
};

export default App;
