<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Campaign Cockpit V5.4 (Fixed)</title>
    
    <!-- 1. STYLING (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. REACT CORE -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- 3. COMPILER (Babel) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- INLINED ICONS (No External Dependencies) -->

    <style>
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // --- GLOBALS ---
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- ICONS ---
        const Icons = {
            Target: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Save: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Upload: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Download: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Plus: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Copy: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            Trash2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            CheckCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            Settings: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            X: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            ArrowRight: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            AlertTriangle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            MousePointer2: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>, 
            Eye: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            MessageCircle: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            Users: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Video: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>,
            TrendingUp: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>
        };

        const { 
            CheckCircle, Copy, Download, Plus, Trash2, Target, Eye, 
            MousePointer2, MessageCircle, TrendingUp, Users, Video, 
            Upload, Settings, X, ArrowRight, AlertTriangle, Save
        } = Icons;

        // --- CONFIGURATION ---
        const PLATFORMS = {
            Facebook: { primary: { safe: 125, max: 63206, lines: 3 }, headline: { safe: 27, max: 255 }, desc: { safe: 30, max: 30 }, hashtags: false },
            Instagram: { primary: { safe: 125, max: 2200, lines: 2 }, headline: { safe: 0, max: 0 }, desc: { safe: 0, max: 0 }, hashtags: true },
            LinkedIn: { primary: { safe: 210, max: 3000, lines: 4 }, headline: { safe: 70, max: 200 }, desc: { safe: 100, max: 200 }, hashtags: true },
            X: { primary: { safe: 280, max: 280, lines: 10 }, headline: { safe: 0, max: 0 }, desc: { safe: 0, max: 0 }, hashtags: true },
            TikTok: { primary: { safe: 90, max: 2200, lines: 2 }, headline: { safe: 0, max: 0 }, desc: { safe: 0, max: 0 }, hashtags: true },
            Snapchat: { primary: { safe: 50, max: 250, lines: 2 }, headline: { safe: 34, max: 34 }, desc: { safe: 0, max: 0 }, hashtags: false }
        };

        const CTAS = {
            Facebook: ['No Button', 'Learn More', 'Sign Up', 'Shop Now', 'Apply Now', 'Book Now', 'Contact Us', 'Download', 'Watch More', 'Get Quote', 'Subscribe', 'Other / Custom'],
            Instagram: ['No Button', 'Learn More', 'Shop Now', 'Sign Up', 'Watch More', 'Apply Now', 'Book Now', 'Link Sticker (Story)', 'Swipe Up (Legacy)', 'Other / Custom'],
            LinkedIn: ['No Button', 'Learn More', 'Apply Now', 'Download', 'View Quote', 'Sign Up', 'Subscribe', 'Register', 'Join', 'Attend', 'Other / Custom'],
            X: ['No Button', 'Visit Website', 'Shop Now', 'Learn More', 'Book Now', 'Play Now', 'Other / Custom'],
            TikTok: ['No Button', 'Learn More', 'Shop Now', 'Sign Up', 'Contact Us', 'Apply Now', 'Book Now', 'Download', 'Play Game', 'Other / Custom'],
            Snapchat: ['No Button', 'INSTALL_APP', 'WATCH', 'VIEW', 'OPEN_APP', 'SIGN_UP', 'SHOP_NOW', 'Other / Custom']
        };

        const KPIS = {
            TRAFFIC: { label: 'Traffic', icon: MousePointer2, color: 'text-blue-600', bg: 'bg-blue-50', border: 'border-blue-200' },
            AWARENESS: { label: 'Awareness', icon: Eye, color: 'text-purple-600', bg: 'bg-purple-50', border: 'border-purple-200' },
            ENGAGEMENT: { label: 'Engagement', icon: MessageCircle, color: 'text-pink-600', bg: 'bg-pink-50', border: 'border-pink-200' },
            LEADS: { label: 'Lead Gen', icon: Users, color: 'text-emerald-600', bg: 'bg-emerald-50', border: 'border-emerald-200' },
            VIDEO_VIEWS: { label: 'Views', icon: Video, color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200' },
            CONVERSION: { label: 'Sales', icon: TrendingUp, color: 'text-indigo-600', bg: 'bg-indigo-50', border: 'border-indigo-200' }
        };

        const DEFAULT_ROW = { id: 1, code: '', platform: 'Facebook', type: 'Static', kpi: 'TRAFFIC', cta: 'Learn More', primaryText: '', headline: '', linkDesc: '', visualText: '', notes: '' };

        const APP_FIELDS = [
            { key: 'code', label: 'Campaign Code / Name', required: false },
            { key: 'platform', label: 'Platform', required: false },
            { key: 'type', label: 'Format', required: false },
            { key: 'cta', label: 'Button / CTA', required: false },
            { key: 'primaryText', label: 'Primary Text (Body)', required: true },
            { key: 'headline', label: 'Headline', required: false },
            { key: 'linkDesc', label: 'Link Description', required: false },
            { key: 'visualText', label: 'Visual Text', required: false },
            { key: 'notes', label: 'Notes', required: false }
        ];

        // --- COMPONENTS ---

        const ImportWizardModal = ({ headers, initialMappings, onConfirm, onCancel }) => {
            const [mappings, setMappings] = useState(initialMappings);
            const handleMappingChange = (fieldKey, columnIndex) => setMappings(prev => ({ ...prev, [fieldKey]: parseInt(columnIndex) }));

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[90vh]">
                        <div className="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-lg">
                            <div><h2 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Settings className="w-5 h-5 text-indigo-600" /> Import Wizard</h2></div>
                            <button onClick={onCancel} className="text-slate-400 hover:text-slate-600"><X className="w-5 h-5" /></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-grow">
                            <div className="space-y-3">
                                {APP_FIELDS.map((field) => {
                                    const currentMapping = mappings[field.key];
                                    const isUnmapped = currentMapping === -1;
                                    return (
                                        <div key={field.key} className="flex items-center gap-4 p-3 border border-slate-100 rounded bg-slate-50/50">
                                            <div className="w-1/3"><div className="text-sm font-semibold text-slate-700">{field.label}</div></div>
                                            <ArrowRight className="w-4 h-4 text-slate-300" />
                                            <div className="flex-grow">
                                                <select className={`w-full text-sm p-2 rounded border focus:ring-2 focus:ring-indigo-500 outline-none ${isUnmapped ? 'border-slate-300 text-slate-400 bg-white' : 'border-indigo-300 bg-indigo-50 text-indigo-700 font-medium'}`} value={currentMapping} onChange={(e) => handleMappingChange(field.key, e.target.value)}>
                                                    <option value="-1">(Ignore)</option>
                                                    {headers.map((header, idx) => <option key={idx} value={idx}>{header || `Col ${idx + 1}`}</option>)}
                                                </select>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="p-5 border-t border-slate-100 flex justify-end gap-3 bg-slate-50 rounded-b-lg">
                            <button onClick={onCancel} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded">Cancel</button>
                            <button onClick={() => onConfirm(mappings)} className="px-6 py-2 text-sm font-bold text-white bg-indigo-600 hover:bg-indigo-700 rounded shadow-sm">Finish Import</button>
                        </div>
                    </div>
                </div>
            );
        };

        const LayeredTextArea = ({ value, onChange, limit, max, linesLimit = 100, kpi, type }) => {
            const [warnings, setWarnings] = useState([]);
            const textareaRef = useRef(null);
            const backdropRef = useRef(null);
            const charCount = (value || '').length;
            
            const handleScroll = () => { if (textareaRef.current && backdropRef.current) backdropRef.current.scrollTop = textareaRef.current.scrollTop; };
            
            let splitIndex = limit;
            let lineBreakIndex = -1;
            let linesFound = 0;
            const safeVal = value || '';
            
            for(let i = 0; i < safeVal.length; i++) {
                if(safeVal[i] === '\n') {
                    linesFound++;
                    if(linesFound >= linesLimit) { lineBreakIndex = i; break; }
                }
            }
            if (lineBreakIndex !== -1 && lineBreakIndex < splitIndex) splitIndex = lineBreakIndex + 1;

            const safeText = safeVal.slice(0, splitIndex);
            const unsafeText = safeVal.slice(splitIndex);
            const isOverSafe = unsafeText.length > 0;
            const isOverMax = charCount > max;

            useEffect(() => {
                const newWarnings = [];
                const lowerVal = safeVal.toLowerCase();
                
                if ((kpi === 'TRAFFIC') && type === 'primary') {
                    if (!safeVal.includes('?') && !safeVal.includes('!') && !safeVal.includes('ðŸ‘‰') && !safeVal.includes('ðŸ‘‡')) newWarnings.push("Tip: Use an action trigger (?, !, ðŸ‘‰)");
                    if (isOverSafe) newWarnings.push("Warning: CTA hidden by 'Read More'.");
                }
                if (kpi === 'ENGAGEMENT' && type === 'primary' && !safeVal.includes('?')) newWarnings.push("Tip: Ask a question.");
                if (kpi === 'CONVERSION' && type === 'primary') {
                    const urgencyWords = ['now', 'today', 'limited', 'only', 'ends', 'last chance'];
                    if (!urgencyWords.some(w => lowerVal.includes(w))) newWarnings.push("Tip: Create urgency.");
                }
                if ((kpi === 'REACH' || kpi === 'AWARENESS') && type === 'primary' && limit > 100 && !safeVal.includes('#')) newWarnings.push("Tip: Add hashtags.");

                setWarnings(newWarnings);
            }, [safeVal, kpi, limit, type, isOverSafe, charCount]);

            return (
                <div className="relative h-full flex flex-col min-h-[140px] w-full">
                    <div className="relative flex-grow w-full border border-slate-200 rounded overflow-hidden bg-white focus-within:ring-1 focus-within:ring-indigo-500 focus-within:border-indigo-500">
                        <div ref={backdropRef} className="absolute inset-0 p-2 text-xs font-mono leading-relaxed whitespace-pre-wrap break-words pointer-events-none select-none z-0 overflow-hidden text-transparent">
                            {safeText}<span className="bg-orange-100 text-transparent decoration-clone box-decoration-clone rounded px-0.5">{unsafeText}</span>
                        </div>
                        <textarea ref={textareaRef} onScroll={handleScroll} className="relative z-10 w-full h-full text-xs p-2 bg-transparent border-none focus:ring-0 resize-none font-mono leading-relaxed text-slate-800" value={value} onChange={(e) => onChange(e.target.value)} spellCheck="false" placeholder={type === 'primary' ? "Type copy here..." : ""} />
                        {isOverMax && <div className="absolute inset-0 border-2 border-red-500 pointer-events-none rounded"></div>}
                    </div>
                    <div className="flex justify-between items-start mt-1">
                        <div className="flex-1 pr-2">
                            {warnings.length > 0 ? <div className="text-[10px] text-orange-600 font-medium leading-tight">{warnings.map((w, i) => <div key={i}>{w}</div>)}</div> : charCount > 0 ? <div className="text-[10px] text-green-600 font-medium flex items-center gap-1"><CheckCircle className="w-3 h-3" /> Optimum</div> : null}
                        </div>
                        <div className={`text-[10px] font-mono font-bold whitespace-nowrap flex flex-col items-end ${isOverMax ? 'text-red-600' : isOverSafe ? 'text-orange-500' : 'text-slate-400'}`}>
                            <span>{charCount} / {limit}</span>
                            {isOverSafe && <span className="text-[9px] uppercase font-bold text-orange-400">Read More Active</span>}
                        </div>
                    </div>
                </div>
            );
        };

        const RowItem = ({ row, updateRow, deleteRow, duplicateRow, smartFill }) => {
            const specs = PLATFORMS[row.platform] || PLATFORMS.Facebook;
            const kpiData = KPIS[row.kpi] || KPIS.TRAFFIC;
            const ctaOptions = CTAS[row.platform] || CTAS.Facebook;
            const isCustomCta = row.cta === 'Other / Custom' || !ctaOptions.includes(row.cta);

            return (
                <div className="group grid grid-cols-[140px_110px_90px_100px_130px_1.5fr_1fr_1fr_0.8fr_0.8fr_50px] gap-0 border-b border-slate-100 hover:bg-slate-50 transition-colors items-start relative min-h-[160px]">
                    <div className="p-2 border-r border-slate-100 h-full"><textarea className="w-full text-xs font-semibold text-slate-600 p-2 bg-slate-50 border border-slate-200 rounded focus:border-indigo-500 focus:bg-white h-full min-h-[120px] resize-none" placeholder="Name/Code" value={row.code || ''} onChange={(e) => updateRow(row.id, 'code', e.target.value)} /></div>
                    <div className="p-2 border-r border-slate-100 h-full flex flex-col justify-between">
                        <select className="w-full text-sm font-medium text-slate-700 bg-transparent border-none focus:ring-0 p-1 cursor-pointer" value={row.platform || 'Facebook'} onChange={(e) => updateRow(row.id, 'platform', e.target.value)}>{Object.keys(PLATFORMS).map(p => <option key={p} value={p}>{p}</option>)}</select>
                        <div className="mt-2 opacity-0 group-hover:opacity-100 transition-opacity"><span className="text-[9px] text-slate-400 font-bold block mb-1">COPY TO:</span><div className="flex flex-wrap gap-1"><button onClick={() => duplicateRow(row)} className="text-[9px] px-1.5 py-0.5 bg-indigo-100 text-indigo-700 rounded border border-indigo-200 hover:bg-indigo-200">SAME</button>{Object.keys(PLATFORMS).filter(p => p !== row.platform).map(p => <button key={p} onClick={() => smartFill(row, p)} className="text-[9px] px-1.5 py-0.5 bg-slate-200 text-slate-600 rounded hover:bg-slate-300">{p.substring(0,2).toUpperCase()}</button>)}</div></div>
                    </div>
                    <div className="p-2 border-r border-slate-100 h-full"><select className="w-full text-xs text-slate-600 bg-slate-50 border border-slate-200 rounded p-1" value={row.type || 'Static'} onChange={(e) => updateRow(row.id, 'type', e.target.value)}><option value="Static">Static</option><option value="Video">Video</option><option value="Carousel">Carousel</option><option value="Story">Story</option><option value="Reel">Reel/TikTok</option></select></div>
                    <div className="p-2 border-r border-slate-100 h-full"><select className={`w-full text-xs p-1.5 rounded border font-medium ${kpiData.color} ${kpiData.bg} ${kpiData.border}`} value={row.kpi || 'TRAFFIC'} onChange={(e) => updateRow(row.id, 'kpi', e.target.value)}>{Object.entries(KPIS).map(([key, data]) => <option key={key} value={key}>{data.label}</option>)}</select><div className="mt-2 text-[10px] text-slate-400 flex justify-center">{kpiData.icon ? <kpiData.icon className="w-4 h-4" /> : null}</div></div>
                    <div className="p-2 border-r border-slate-100 h-full bg-slate-50/50">
                        {isCustomCta ? (
                            <div className="flex flex-col gap-1 h-full"><input type="text" className="w-full text-xs p-2 border border-indigo-300 rounded bg-white focus:ring-1 focus:ring-indigo-500" value={row.cta === 'Other / Custom' ? '' : (row.cta || '')} placeholder="Enter CTA..." onChange={(e) => updateRow(row.id, 'cta', e.target.value)} autoFocus /><button onClick={() => updateRow(row.id, 'cta', ctaOptions[0])} className="text-[9px] text-slate-400 underline self-end">Back to list</button></div>
                        ) : (
                            <select className="w-full text-xs text-slate-700 bg-white border border-slate-200 rounded p-1.5 focus:border-indigo-500" value={row.cta || 'Learn More'} onChange={(e) => updateRow(row.id, 'cta', e.target.value)}>{ctaOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}</select>
                        )}
                        <div className="mt-2 text-[9px] text-slate-400 leading-tight">{row.type === 'Story' ? 'Use Sticker/Swipe' : 'Button on Ad'}</div>
                    </div>
                    <div className="p-2 border-r border-slate-100 h-full relative min-h-[140px]"><LayeredTextArea value={row.primaryText || ''} onChange={(val) => updateRow(row.id, 'primaryText', val)} limit={specs.primary.safe} max={specs.primary.max} linesLimit={specs.primary.lines} kpi={row.kpi} type="primary" /></div>
                    <div className="p-2 border-r border-slate-100 h-full bg-slate-50/30">{specs.headline.max > 0 ? <LayeredTextArea value={row.headline || ''} onChange={(val) => updateRow(row.id, 'headline', val)} limit={specs.headline.safe} max={specs.headline.max} kpi={row.kpi} type="headline" rows={2} /> : <div className="text-xs text-slate-300 italic p-2 text-center mt-4">N/A</div>}</div>
                    <div className="p-2 border-r border-slate-100 h-full">{specs.desc.max > 0 ? <LayeredTextArea value={row.linkDesc || ''} onChange={(val) => updateRow(row.id, 'linkDesc', val)} limit={specs.desc.safe} max={specs.desc.max} kpi={row.kpi} type="plain" rows={2} /> : <div className="text-xs text-slate-300 italic p-2 text-center mt-4">N/A</div>}</div>
                    <div className="p-2 border-r border-slate-100 h-full"><textarea className="w-full text-xs p-2 border border-slate-200 rounded focus:border-indigo-500 focus:bg-white h-full min-h-[100px] bg-white" placeholder="Text overlay..." value={row.visualText || ''} onChange={(e) => updateRow(row.id, 'visualText', e.target.value)} /></div>
                    <div className="p-2 border-r border-slate-100 h-full"><textarea className="w-full text-xs p-2 border-transparent bg-transparent hover:bg-white hover:border-slate-200 rounded focus:border-indigo-500 focus:bg-white h-full min-h-[100px]" placeholder="Notes..." value={row.notes || ''} onChange={(e) => updateRow(row.id, 'notes', e.target.value)} /></div>
                    <div className="p-2 flex flex-col items-center gap-2 pt-4"><button onClick={() => duplicateRow(row)} className="text-slate-400 hover:text-indigo-600"><Copy className="w-4 h-4" /></button><button onClick={() => deleteRow(row.id)} className="text-slate-400 hover:text-red-500"><Trash2 className="w-4 h-4" /></button></div>
                </div>
            );
        };

        const App = () => {
            const [rows, setRows] = useState(() => {
                const saved = localStorage.getItem('social_cockpit_data_v1');
                if (saved) {
                    try { return JSON.parse(saved); } 
                    catch (e) { console.error(e); return [DEFAULT_ROW]; }
                }
                return [DEFAULT_ROW];
            });
            const [lastSaved, setLastSaved] = useState(null);
            
            const fileInputRef = useRef(null);
            const [isLoadingLibrary, setIsLoadingLibrary] = useState(false);
            const [importWizardData, setImportWizardData] = useState(null);
            const [showImportModal, setShowImportModal] = useState(false);

            useEffect(() => {
                const timer = setTimeout(() => {
                    localStorage.setItem('social_cockpit_data_v1', JSON.stringify(rows));
                    setLastSaved(new Date());
                }, 500);
                return () => clearTimeout(timer);
            }, [rows]);

            const clearData = () => {
                if(confirm("Are you sure? This will delete all rows and start fresh.")) {
                    const fresh = [{ ...DEFAULT_ROW, id: Date.now() }];
                    setRows(fresh);
                    localStorage.setItem('social_cockpit_data_v1', JSON.stringify(fresh));
                }
            };

            const addRow = () => setRows([...rows, { ...DEFAULT_ROW, id: Date.now() + Math.random() }]);
            const deleteRow = (id) => rows.length > 1 && setRows(rows.filter(r => r.id !== id));
            const updateRow = (id, field, value) => setRows(rows.map(r => r.id === id ? { ...r, [field]: value } : r));
            const duplicateRow = (row) => setRows([...rows, { ...row, id: Date.now() + Math.random() }]);
            const smartFill = (sourceRow, targetPlatform) => setRows([...rows, { ...sourceRow, id: Date.now() + Math.random(), platform: targetPlatform }]);

            const handleFileUpload = async (event) => {
                const file = event.target.files[0]; if (!file) return;
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) await processXLSX(file);
                else { const reader = new FileReader(); reader.onload = (e) => processCSV(e.target.result); reader.readAsText(file); }
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const loadXLSXLibrary = () => {
                return new Promise((resolve, reject) => {
                    if (window.XLSX) return resolve(window.XLSX);
                    setIsLoadingLibrary(true);
                    const script = document.createElement('script');
                    script.src = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
                    script.onload = () => { setIsLoadingLibrary(false); resolve(window.XLSX); };
                    script.onerror = () => { setIsLoadingLibrary(false); reject(new Error("Failed to load XLSX")); };
                    document.body.appendChild(script);
                });
            };

            const processXLSX = async (file) => {
                try {
                    const XLSX = await loadXLSXLibrary();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheetName = workbook.SheetNames[0];
                        const json = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheetName], { header: 1, defval: "" });
                        if (json.length > 0) analyzeImportData(json);
                    };
                    reader.readAsArrayBuffer(file);
                } catch (err) { alert("Error parsing Excel: " + err.message); }
            };

            const processCSV = (csvText) => {
                const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
                const parseLine = (line) => {
                    const res = []; let start=0, inQ=false;
                    for(let i=0; i<line.length; i++) {
                        if(line[i]==='"') inQ=!inQ;
                        else if(line[i]===',' && !inQ) { res.push(line.substring(start,i).replace(/^"|"$/g,'').replace(/""/g,'"')); start=i+1; }
                    }
                    res.push(line.substring(start).replace(/^"|"$/g,'').replace(/""/g,'"'));
                    return res;
                };
                analyzeImportData(lines.map(parseLine));
            };

            const analyzeImportData = (rowsArray) => {
                if (rowsArray.length < 2) return alert("File empty/invalid.");
                const headers = rowsArray[0].map(h => String(h).trim());
                const lowerHeaders = headers.map(h => h.toLowerCase());
                const initialMappings = { code: -1, platform: -1, type: -1, cta: -1, primaryText: -1, headline: -1, linkDesc: -1, visualText: -1, notes: -1 };
                const keywords = {
                    code: ['code', 'case', 'naam', 'campaign'], platform: ['platform', 'channel'], type: ['format', 'type'], cta: ['cta', 'button', 'knop', 'action'],
                    primaryText: ['primary', 'intro', 'text', 'copy'], headline: ['headline', 'title'], linkDesc: ['desc', 'sub'], visualText: ['visual', 'image'], notes: ['note']
                };
                lowerHeaders.forEach((h, idx) => {
                    for(const [key, words] of Object.entries(keywords)) {
                        if(initialMappings[key] === -1 && words.some(w => h.includes(w))) initialMappings[key] = idx;
                    }
                });
                setImportWizardData({ headers, data: rowsArray.slice(1), mappings: initialMappings });
                setShowImportModal(true);
            };

            const finalizeImport = (mappings) => {
                const newRows = [];
                const { data } = importWizardData;
                for(let i=0; i<data.length; i++) {
                    const cols = data[i]; if(cols.length < 1) continue;
                    let code = mappings.code > -1 ? cols[mappings.code] : cols[0];
                    let plat = mappings.platform > -1 ? cols[mappings.platform] : 'Facebook';
                    const str = String(code).toLowerCase() + String(plat).toLowerCase();
                    if(str.includes('insta')) plat='Instagram'; else if(str.includes('tik')) plat='TikTok'; else if(str.includes('snap')) plat='Snapchat'; else if(str.includes('link')) plat='LinkedIn'; else if(str.includes('x') || str.includes('twitter')) plat='X'; else plat='Facebook';
                    
                    const ctaVal = (mappings.cta > -1 && cols[mappings.cta]) ? String(cols[mappings.cta]) : 'Learn More';

                    newRows.push({
                        id: Date.now() + i + Math.random(), // Unique ID fix
                        code: code || '', 
                        platform: plat, 
                        type: 'Static', 
                        kpi: 'TRAFFIC', 
                        cta: ctaVal,
                        primaryText: mappings.primaryText > -1 ? (cols[mappings.primaryText]||'') : '',
                        headline: mappings.headline > -1 ? (cols[mappings.headline]||'') : '',
                        linkDesc: mappings.linkDesc > -1 ? (cols[mappings.linkDesc]||'') : '',
                        visualText: mappings.visualText > -1 ? (cols[mappings.visualText]||'') : '',
                        notes: mappings.notes > -1 ? (cols[mappings.notes]||'') : ''
                    });
                }
                if(newRows.length>0) setRows(prev => (prev.length===1 && prev[0].primaryText==='') ? newRows : [...prev, ...newRows]);
                setShowImportModal(false); setImportWizardData(null);
            };

            const exportCSV = () => {
                const headers = ["Code", "Platform", "Type", "KPI", "Button/CTA", "Primary Text", "Headline", "Link Description", "Visual Text", "Notes"];
                const csvContent = [headers.join(","), ...rows.map(r => [
                    `"${String(r.code||'').replace(/"/g,'""')}"`,`"${r.platform}"`,`"${r.type}"`,`"${r.kpi}"`,`"${r.cta}"`,
                    `"${String(r.primaryText||'').replace(/"/g,'""')}"`,`"${String(r.headline||'').replace(/"/g,'""')}"`,`"${String(r.linkDesc||'').replace(/"/g,'""')}"`,
                    `"${String(r.visualText||'').replace(/"/g,'""')}"`,`"${String(r.notes||'').replace(/"/g,'""')}"`
                ].join(","))].join("\n");
                const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csvContent], {type:'text/csv'}));
                link.download = "campaign_export.csv"; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            return (
                <div className="min-h-screen pb-20">
                    <header className="bg-white border-b border-slate-200 px-6 py-4 sticky top-0 z-20 shadow-sm">
                        <div className="max-w-[1800px] mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Target className="w-6 h-6 text-indigo-600"/> Social Campaign Cockpit</h1>
                                <p className="text-xs text-slate-500 mt-1">V5.4: Stable (Fixed Import)</p>
                            </div>
                            <div className="flex items-center gap-3">
                                {lastSaved && <span className="text-[10px] text-green-600 font-medium flex items-center gap-1 animate-pulse"><Save className="w-3 h-3" /> Saved</span>}
                                <button onClick={clearData} className="text-xs text-red-400 hover:text-red-600 underline mr-2">Start Fresh</button>
                                <div className="h-6 w-px bg-slate-200 mx-1"></div>
                                <input type="file" accept=".csv, .xlsx, .xls" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                                <button onClick={() => fileInputRef.current.click()} disabled={isLoadingLibrary} className="flex items-center gap-2 px-4 py-2 bg-white text-slate-600 border border-slate-300 rounded-md hover:bg-slate-50 font-medium text-sm disabled:opacity-50"><Upload className="w-4 h-4" /> {isLoadingLibrary?'Loading...':'Import'}</button>
                                <button onClick={exportCSV} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-medium text-sm shadow-sm"><Download className="w-4 h-4" /> Export</button>
                            </div>
                        </div>
                    </header>
                    {showImportModal && importWizardData && <ImportWizardModal headers={importWizardData.headers} initialMappings={importWizardData.mappings} onConfirm={finalizeImport} onCancel={() => {setShowImportModal(false); setImportWizardData(null);}} />}
                    <main className="max-w-[1800px] mx-auto py-6 overflow-x-auto px-4">
                        <div className="bg-white border border-slate-200 shadow-sm rounded-lg min-w-[1600px]">
                            <div className="grid grid-cols-[140px_110px_90px_100px_130px_1.5fr_1fr_1fr_0.8fr_0.8fr_50px] gap-0 border-b border-slate-200 bg-slate-50 text-xs font-semibold text-slate-500 uppercase tracking-wider sticky top-0 z-10">
                                <div className="p-3 border-r">Code/Case</div><div className="p-3 border-r">Platform</div><div className="p-3 border-r">Format</div><div className="p-3 border-r">Goal</div><div className="p-3 border-r">Button/CTA</div>
                                <div className="p-3 border-r flex justify-between">Primary Text <span className="text-[10px] text-slate-400 font-normal">ðŸŸ§ = hidden</span></div>
                                <div className="p-3 border-r">Headline</div><div className="p-3 border-r">Link Desc</div><div className="p-3 border-r">Visual Text</div><div className="p-3 border-r">Notes</div><div className="p-3 text-center">Actions</div>
                            </div>
                            {rows.map(row => <RowItem key={row.id} row={row} updateRow={updateRow} deleteRow={deleteRow} duplicateRow={duplicateRow} smartFill={smartFill} />)}
                        </div>
                        <div className="mt-8 text-center"><button onClick={addRow} className="inline-flex items-center gap-2 px-6 py-3 bg-white border border-slate-300 text-slate-600 rounded-full hover:bg-slate-50 font-medium text-sm shadow-sm"><Plus className="w-4 h-4" /> Add New Item</button></div>
                    </main>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
